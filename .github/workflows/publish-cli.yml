name: Publish CLI

# Publishes @heygaia/cli from an explicit release tag/version pair.
on:
  # Manual dispatch keeps CLI publish intentional and auditable.
  workflow_dispatch:
    inputs:
      # Expected format: cli-vX.Y.Z.
      tag:
        description: "Release tag (e.g. cli-v0.1.3)"
        required: true
      # Expected format: X.Y.Z.
      version:
        description: "Release version (e.g. 0.1.3)"
        required: true

jobs:
  publish:
    # OIDC token enables npm provenance signing.
    runs-on: blacksmith-4vcpu-ubuntu-2404
    permissions:
      contents: read
      id-token: write
    steps:
      # Checkout repository to read package and release manifest metadata.
      - name: Checkout
        uses: actions/checkout@v4

      # Install Node toolchain for build/publish.
      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      # Normalize manual inputs into reusable step outputs.
      - name: Resolve release inputs
        id: release
        env:
          TAG_INPUT: ${{ github.event.inputs.tag }}
          VERSION_INPUT: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail

          TAG="$TAG_INPUT"
          VERSION="$VERSION_INPUT"

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      # Validate tag/version/manifest consistency and skip if npm already has this version.
      - name: Verify CLI release tag/version and npm idempotency
        id: verify
        env:
          RELEASE_TAG: ${{ steps.release.outputs.tag }}
          RELEASE_VERSION: ${{ steps.release.outputs.version }}
        run: node scripts/ci/verify-cli-release.mjs --tag "$RELEASE_TAG" --version "$RELEASE_VERSION"

      # Build only when publish is actually required.
      - name: Install dependencies
        if: steps.verify.outputs.should_publish == 'true'
        run: pnpm install --frozen-lockfile
        working-directory: packages/cli

      - name: Build
        if: steps.verify.outputs.should_publish == 'true'
        run: pnpm run build
        working-directory: packages/cli

      - name: Publish to npm
        if: steps.verify.outputs.should_publish == 'true'
        run: npm publish --provenance --access public
        working-directory: packages/cli
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Idempotent rerun path: emit clear skip message.
      - name: Skip publish for existing npm version
        if: steps.verify.outputs.should_publish != 'true'
        env:
          RELEASE_VERSION: ${{ steps.release.outputs.version }}
        run: echo "Skipping publish because @heygaia/cli@$RELEASE_VERSION already exists on npm."
