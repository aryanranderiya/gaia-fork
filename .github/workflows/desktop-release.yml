name: Desktop Release

# Builds desktop installers for each OS and uploads artifacts to the published GitHub Release.
on:
  # Fires after a release is published; workflow filters to desktop tags below.
  release:
    types: [published]

concurrency:
  # Prevent duplicate builds for the same release tag.
  group: desktop-release-${{ github.event.release.tag_name || github.run_id }}
  cancel-in-progress: false

permissions:
  # Needed to upload build artifacts to GitHub Releases.
  contents: write

jobs:
  build:
    # Only run for desktop release tags (example: desktop-v0.1.2).
    if: startsWith(github.event.release.tag_name, 'desktop-v')

    # Build installers in parallel across supported operating systems.
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: mac
          - os: blacksmith-4vcpu-ubuntu-2404
            target: win
          - os: ubuntu-latest
            target: linux

    runs-on: ${{ matrix.os }}

    steps:
      # Checkout source for package/build tooling.
      - uses: actions/checkout@v4

      # Install Node package manager + runtime.
      - uses: pnpm/action-setup@v4
        with:
          version: 10.17.1

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Keep desktop package version aligned with release tag before packaging.
      - name: Set version from tag
        shell: bash
        run: |
          TAG="${{ github.event.release.tag_name }}"
          if [ -n "$TAG" ]; then
            # Strip component prefix (e.g., 'desktop-v0.11.0' -> '0.11.0')
            VERSION="${TAG#*-v}"
            # Fallback: if tag is just 'v0.11.0' format, strip the 'v'
            VERSION="${VERSION#v}"
            echo "Setting desktop version to: $VERSION"
            cd apps/desktop
            # Update version in package.json using node
            node -e "const pkg = require('./package.json'); pkg.version = '$VERSION'; require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');"
            UPDATED_VERSION="$(node -p 'require("./package.json").version')"
            echo "Updated package.json version to: $UPDATED_VERSION"
          else
            echo "No tag provided, using version from package.json"
          fi

      # Linux builders need extra packaging tools for .rpm output.
      - name: Install Linux packaging dependencies
        if: matrix.target == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      # Build platform-specific desktop distribution artifacts.
      - name: Build Desktop (${{ matrix.target }})
        run: pnpm nx dist:${{ matrix.target }} desktop
        env:
          CI: true
          NEXT_PUBLIC_API_BASE_URL: https://api.heygaia.io/api/v1/
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Attach all generated installer/update files to the existing release entry.
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            apps/desktop/release/**/*.dmg
            apps/desktop/release/**/*.zip
            apps/desktop/release/**/*.exe
            apps/desktop/release/**/*.AppImage
            apps/desktop/release/**/*.deb
            apps/desktop/release/**/*.rpm
            apps/desktop/release/**/latest*.yml
