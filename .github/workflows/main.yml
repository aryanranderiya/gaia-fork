name: Quality Checks

# Primary CI gate: validates code quality and enforces branch promotion policy.
on:
  # PR validation for both integration (develop) and production promotion (master).
  pull_request:
    branches:
      - develop
      - master
  # Push checks on master; successful runs trigger downstream build/deploy workflow.
  push:
    branches:
      - master
  # Manual trigger for ad-hoc CI execution.
  workflow_dispatch:

jobs:
  # Runs lint/type/build checks and enforces master branch workflow rules.
  quality-checks:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    permissions:
      contents: write
      pull-requests: read
      actions: read

    steps:
      # Full history improves Nx affected/base-head resolution.
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Enforce that master only receives changes promoted from develop or release-please.
      - name: Enforce master promotion policy
        if: github.event_name == 'pull_request' && github.base_ref == 'master'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const isAllowedMasterSource = (ref) =>
              ref === "develop" || (typeof ref === "string" && ref.startsWith("release-please--"));

            const pr = context.payload.pull_request;
            if (pr.base.ref === "master" && !isAllowedMasterSource(pr.head.ref)) {
              core.setFailed(
                `PRs to master must come from develop or release-please branches. Received '${pr.head.ref}' -> '${pr.base.ref}'.`,
              );
              return;
            }
            core.info(`Master PR policy passed: ${pr.head.ref} -> ${pr.base.ref}`);

      # Compute NX_BASE/NX_HEAD for affected-task execution.
      - name: Set Nx SHAs
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: master

      # Toolchain bootstrap for Node + Python quality checks.
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.15.1"
          cache: "pnpm"

      - name: Setup uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      # Install workspace dependencies once for all checks.
      - name: Install workspace dependencies
        run: pnpm install --frozen-lockfile

      # Guard against release manifest/version drift before releases are cut.
      - name: Validate release manifest versions
        run: node scripts/ci/validate-release-manifest.mjs

      - name: Sync Python dependencies (Nx cached)
        run: npx nx sync api
        # env:
        #   NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

      - name: Install prek
        run: uv tool install prek

      - name: Install mypy types
        run: uv run mypy --install-types --non-interactive
        working-directory: apps/api

      - name: Install vulture
        run: uv tool install vulture

      - name: Dead code check
        run: bash scripts/dead-code-check.sh
        # Temporarily disable --strict flag.

      # Execute only checks impacted by the current change-set.
      - name: Run affected quality checks
        run: npx nx affected -t lint type-check build --parallel=3
        env:
          NEXT_PUBLIC_API_BASE_URL: "http://fake-api-for-build.example.com"
          # NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

  # Only trigger image build/deploy planning on master after quality gate passes.
  trigger-build:
    needs: [quality-checks]
    if: github.ref == 'refs/heads/master'
    uses: ./.github/workflows/build.yml
    secrets: inherit # pragma: allowlist secret
